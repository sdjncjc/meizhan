<!--#include virtual="head.html"-->
    <link rel="stylesheet" href="/css/member/orders.css" />
<!--#include virtual="/tpl/navbar.html"-->
    <section class="wrapper J_wrapper" id="wrapper">
        <section class="grid-wrap orders">
            <script id="order-list-template" type="text/template">
                {{each data as order index}}
                <section class="grid orders-list">
                    <header class="row-1">
                        订单编号：
                        <span>{{order.order_sn}}</span>
                        {{if order.order_state == 0}}
                        <a onclick="delOrder({{order.order_id}})" href="javascript:void(0);" data-order-id="{{order.order_id}}">删除订单</a>
                        {{/if}}
                        {{if order.order_state == 10}}
                        <a onclick="cancelOrder({{order.order_id}})" href="javascript:void(0);" data-order-id="{{order.order_id}}">取消订单</a>
                         {{/if}}
                    </header>
                    {{each order.extend_order_goods as order_goods}}
                    <div class="row-3 orders-item-list">
                        <img class="col-3 lazy" src="/img/blank.png" data-original="{{order_goods.img_url}}" alt="{{order_goods.goods_name}}">
                        <a onclick="open_url('orders','orderinfo',{{order.order_id}})" href="javascript:void(0)">
                            <div class="col-9 orders-item-info">
                                <p>订单时间：
                                    <span class="order-no">{{order.add_time}}</span>
                                </p>
                                <p>金额：¥
                                    <span class="order-price">{{order_goods.goods_price}}</span>
                                    <span class="order-count">共{{order_goods.goods_num}}件&nbsp;&nbsp;&nbsp;&gt;</span>
                                </p>
                                <p>
                                    <span class="order-status">{{order_goods.goods_spec}}</span>
                                </p>
                            </div>
                            <!-- end .orders-item-list -->
                        </a>
                    </div>
                    <!-- end .orders-item-list -->
                    {{/each}}
                    <footer>
                        总计：¥
                        <span>{{order.order_amount}}</span>
                    </footer>
                    <!-- end footer -->
                    {{if order.order_state == 10}}
                    <aside class="pay">
                        <a class="J_payOrder" href="javascript:void(0)" data-tid="{{order.order_id}}" data-fee="{{order.order_amount}}">立即支付</a>
                    </aside>
                    {{/if}}
                    {{if order.order_state == 30}}
                    <aside class="receipt">
                        <a class="J_MakePoint" href="javascript:void(0)" data-shipment-id="{{order.shipping_code}}" data-order-id="{{order.order_id}}">确认收货</a>
                        <a href="/trade/shipment.html?order_id=${item.id}&amp;shipment_id=${item.shipment_id}">查看物流</a>
                    </aside>
                    {{/if}}
                    {{if order.order_state == 40}}
                    <aside class="receipt">
                        <a href="javascript:;" class="J_receipt">去评价</a>
                    </aside>
                    {{/if}}
                    <aside class="wave"></aside>
                </section>
                <!-- end orders-list -->
                {{/each}}
            </script>
            <script id="order-empty-template" type="text/template">
                <i class="order-img"></i>
                <p class="order-hint">暂无订单</p>
                <a class="order-btn" href="/">逛逛今日特卖</a>
            </script>
        </section>
        <!-- end .orders -->
        <div class="loading">
            正在加载...
        </div>
        <section id="payment" class="payment-list hidden"></section>
    </section>
    <section class="order-refund-reason hidden">
        <div class="title"><a href="javascript:;" class="btn btn-cancel">取消</a>请选择取消订单的原因？<a href="javascript:;" class="btn btn-ok">确定</a>
        </div>
        <ul class="box">
            <li class="item" data-reason="买错了">买错了</li>
            <li class="item" data-reason="不想买了">不想买了</li>
            <li class="item" data-reason="信息填写错误，重新下单">信息填写错误，重新下单</li>
            <li class="item" data-reason="重复购买">重复购买</li>
            <li class="item" data-reason="支付遇到问题">支付遇到问题</li>
            <li class="item" data-reason="其他原因">其他原因</li>
        </ul>
    </section>
    <script type="text/javascript">
    $(function(){
        var title = "全部订单";
        var status = GetQueryString("status");
        switch(status){
            case '10':
                title = "待付款";
                break;
            case '20':
                title = "待发货";
                break;
            case '30':
                title = "待收货";
                break;
            case '40':
                title = "待评价";
                break;
            case 'sold':
                title = "售后订单";
                break;
        }
        set_title(title);
        function ajax_getOrder(){      
            if(stop)return;
            var url = getUrl('mz_member_order','getOrders',"type="+status+"&page=" + page);
            getAjaxResult(url,'order-list-template',".orders",'order-empty-template');
        }
        // 全部订单
        ajax_getOrder();
        $(window).scroll(function() {
            if($('.loading').offset().top < $(window).scrollTop() + 1.3*$(window).height()){
                if(!stop){
                    $(".loading").show();
                    ajax_getOrder();
                    stop = true;
                }
            }
        });
    });
    function delOrder(id){
         if(window.confirm("确定要删除此订单吗？")){
            var url = getUrl('mz_member_order','recycleOrder','order_id='+id);
            ajax_do(url);
         }
    }
        var d = "";
    function cancelOrder(id){
        d = "";
        $(".order-refund-reason").removeClass("hidden");
        $(".order-refund-reason .item").tap(function() {
                $(this).addClass("current").siblings().removeClass("current"),
                d = $(this).attr("data-reason");
        });
 
    }
   $(".order-refund-reason .btn-ok").tap(function() {
        if (d){
            if (window.confirm("确定要取消订单吗？")) {
                var url = getUrl('mz_member_order','cancelOrder','order_id='+id + '&reason=' + d);
                ajax_do(url);
            };
        }else{
            alert("请选择取消订单的原因？");
        }
    });
    $(".order-refund-reason").on("touchend", ".btn-cancel",function() {
        $(".order-refund-reason").addClass("hidden").find("li").removeClass("current");
        d = "";
    });
    </script>
</body>

</html>
